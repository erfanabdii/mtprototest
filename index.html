<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Telegram Proxy Explorer — MTProto & SOCKS5</title>

  <style>
    /* =========================
       THEME TOKENS
       ========================= */
    :root{
      /* core palette */
      --title-fg: #0b1220;            /* dark */
      --bg:#0b0f14;
      --bg-elev:#0e141b;
      --card:#121821;

      /* neutral surfaces */
      --chip:#111827;
      --chip-fg:#cdd6e5;
      --chip-border:#2a3950;

      /* text */
      --text:#e6edf3;
      --muted:#a8b3c7;
      --muted-strong:#d1dae8;

      /* accents */
      --accent:#4fc3f7;
      --ok:#47d16b; --warn:#ffb02e; --bad:#ff6b6b;

      /* high-contrast chips (dark) */
      --ok-bg:#0d2a19;   --ok-fg:#9ff2b7; --ok-bd:#1f6633;
      --wn-bg:#2b1e06;   --wn-fg:#ffd48a; --wn-bd:#6b4f1a;
      --bd-bg:#2a0e10;   --bd-fg:#ffb4b4; --bd-bd:#6b2222;

      /* tabs */
      --tab-active-bg: color-mix(in oklab, var(--chip) 80%, var(--accent) 20%);
      --tab-active-fg:#eaf6ff;

      --container: min(1100px, 100% - 24px);
      --radius: 14px;
      --radius-lg: 18px;

      --shadow-1: 0 1px 0 rgba(0,0,0,.5), 0 6px 18px rgba(0,0,0,.35);
      --shadow-2: 0 2px 0 rgba(0,0,0,.55), 0 18px 60px rgba(0,0,0,.45);

      --ring: 0 0 0 2px var(--accent), 0 0 0 6px rgba(79,195,247,.18);
      --grad-ambient:
        radial-gradient(1200px 600px at 10% -10%, rgba(79,195,247,.16), transparent 60%),
        radial-gradient(900px 500px at 110% 0%, rgba(34,211,238,.12), transparent 60%);
    }

    @media (prefers-color-scheme: light) {
      :root{
        --bg:#f7fafc; --bg-elev:#ffffff; --card:#ffffff;
        --chip:#f3f5f9; --chip-fg:#334155; --chip-border:#d9e0ea;
        --text:#0b1220; --muted:#5b6474; --muted-strong:#4a5568;
        --title-fg: #eaf6ff;           /* light */

        /* high-contrast chips (light) */
        --ok-bg:#e7f9ee; --ok-fg:#116b2e; --ok-bd:#b6e7c7;
        --wn-bg:#fff5e0; --wn-fg:#8a5b00; --wn-bd:#ffd89f;
        --bd-bg:#ffe8ea; --bd-fg:#a22323; --bd-bd:#ffc3c6;

        --tab-active-bg: color-mix(in oklab, white 88%, var(--accent) 12%);
        --tab-active-fg:#0b1220;
      }
      body { background: linear-gradient(180deg,#f4f7fb,#f7fafc 120%); }
      header { background: #ffffffea }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      color:var(--text);
      background:
        var(--grad-ambient),
        /* top stripe color is here (#09121c) blending into --bg */
        linear-gradient(180deg,#09121c 0%, var(--bg) 120%);
      line-height:1.45;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      text-rendering:optimizeLegibility;
    }

    a{color:inherit}
    a:hover{opacity:.9}

    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    /* =========================
       HEADER & TABS
       ========================= */
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: saturate(160%) blur(10px);
      /* header gradient colors are here */
      background: linear-gradient(180deg, rgba(9,13,18,.96), rgba(9,13,18,.88));
      border-bottom:1px solid var(--chip-border);
      padding:12px 12px 8px;
      box-shadow: 0 1px 0 rgba(0,0,0,.2);
    }
    header > *{ width:var(--container); margin-inline:auto; }
    h1{font-size:clamp(20px,2.4vw,24px);margin:0;letter-spacing:.2px}
    header h1 {
      color: var(--title-fg);   /* use your new theme variable */
      font-weight: 800;         /* optional polish */
      letter-spacing: .1px;     /* optional polish */
    }

    .sub{color:var(--muted-strong);font-size:13px}
    header .sub{ color:#d9e3f1 }

    .tabs{
      position:relative; margin-top:10px;
      display:flex; gap:8px; width:var(--container); margin-inline:auto;
      border-bottom:1px solid var(--chip-border);
    }
    .tab{
      /* kill native iOS/Safari button styling that made the tab white */
      appearance:none; -webkit-appearance:none;
      position:relative;
      padding:10px 14px; border-radius:10px;
      background:var(--chip); color:var(--text);
      cursor:pointer; border:1px solid var(--chip-border);
      transition: transform .15s ease, border-color .15s ease, background-color .15s ease, color .15s ease;
      user-select:none;
    }
    .tab:hover{ transform: translateY(-1px); border-color:#3d4c67; }
    .tab[aria-selected="true"]{
      background:var(--tab-active-bg);
      color:var(--tab-active-fg);
      border-color: color-mix(in oklab, var(--accent) 35%, var(--chip-border));
      box-shadow: inset 0 0 0 1px rgba(79,195,247,.2);
    }
    .tabs::after{
      content:"";
      position:absolute; left:8px; right:8px; bottom:-1px;
      height:1px; background:linear-gradient(90deg, transparent, rgba(79,195,247,.4), transparent);
      pointer-events:none;
    }

    /* =========================
       LAYOUT
       ========================= */
    main{ width:var(--container); margin:18px auto; }
    .toolbar{ display:flex; flex-wrap:wrap; gap:10px 14px; align-items:center; margin:12px 0 10px; }
    .metrics{ color:var(--muted-strong) }

    /* filters */
    .filters{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:4px }
    .filters label{ display:flex; align-items:center; gap:6px; color:var(--muted-strong); font-size:13px }

    /* =========================
       FORMS & BUTTONS
       ========================= */
    button,select,input[type="text"]{
      appearance:none; -webkit-appearance:none;
      background:var(--chip); color:var(--text);
      border:1px solid var(--chip-border); border-radius:12px;
      padding:8px 12px; cursor:pointer;
      transition: border-color .15s ease, background-color .15s ease, transform .15s ease, box-shadow .15s ease;
    }
    input[type="text"]{ cursor:text; min-width:180px }
    input::placeholder{ color:var(--muted-strong); opacity:.95 }
    button:hover,select:hover,input[type="text"]:hover{ border-color:#3d4c67 }
    button:active{ transform: translateY(1px) }

    /* segmented control */
    .seg{ display:inline-flex; border:1px solid var(--chip-border); border-radius:12px; overflow:hidden; background:var(--chip) }
    .seg input{ position:absolute; opacity:0; pointer-events:none }
    .seg label{
      padding:8px 10px; user-select:none; cursor:pointer; font-weight:600;
      color:var(--chip-fg); background:transparent; border-right:1px solid var(--chip-border);
    }
    .seg label:last-of-type{ border-right:none }
    .seg input:checked + label{
      color:#fff; background:linear-gradient(180deg,#2563eb,#1e40af);
      box-shadow: inset 0 0 0 1px rgba(59,130,246,.45);
    }

    /* clear button (ghost) with higher contrast */
    .ghost{
      background:rgba(255,255,255,.03);
      color:#e9efff;
      border:1px dashed #6b7a97;
    }
    .ghost:hover{
      background:rgba(79,195,247,.08);
      border-color:#8aa0c7;
      color:#ffffff;
    }

    .actions a,.actions button{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:12px; border:1px solid #3b4a66;
      text-decoration:none; background:#1e3a8a; color:#fff; font-weight:600;
      transition: filter .15s ease, transform .15s ease, box-shadow .15s ease;
      box-shadow: 0 2px 12px rgba(23,37,84,.35);
      white-space:nowrap; min-width:max-content;
    }
    .actions a:hover,.actions button:hover{ filter:brightness(1.1) }
    .actions a:active,.actions button:active{ transform: translateY(1px) }
    .actions a.primary{
      border-color:#3b82f6; background:linear-gradient(180deg,#2563eb,#1e40af);
      box-shadow: 0 4px 18px rgba(37,99,235,.35);
    }

    .tab:focus-visible,
    button:focus-visible,
    select:focus-visible,
    input[type="text"]:focus-visible,
    .actions a:focus-visible{
      outline:none; box-shadow: var(--ring);
    }

    /* =========================
       GRID & CARDS
       ========================= */
    .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:12px; }
    .card{
      background: linear-gradient(180deg, var(--card), color-mix(in oklab, var(--bg-elev) 94%, transparent));
      border:1px solid var(--chip-border);
      border-radius:16px;
      padding:12px;
      display:flex; flex-direction:column; gap:10px;
      box-shadow: var(--shadow-1);
      transition: border-color .18s ease, box-shadow .18s ease, transform .18s ease;
      container-type:inline-size;
    }
    .card:hover{
      border-color: color-mix(in oklab, var(--accent) 30%, var(--chip-border));
      box-shadow: var(--shadow-2);
      transform: translateY(-2px);
    }
    .card:focus-within{ box-shadow: var(--shadow-2), 0 0 0 2px rgba(79,195,247,.15) inset }

    .top{ display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center }
    .host{
      min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      line-height:1.25; font-weight:700; letter-spacing:.2px;
    }
    .meta{display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end}

    .chip{
      font-size:12px; color:var(--chip-fg);
      background: var(--chip);
      border:1px solid var(--chip-border); border-radius:999px; padding:4px 10px;
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
      max-width: clamp(96px, 33vw, 180px);
      overflow:hidden; text-overflow:ellipsis;
    }
    .chip::before{
      content:""; width:6px; height:6px; border-radius:50%; background:currentColor;
      opacity:.75; box-shadow: 0 0 0 2px rgba(255,255,255,.06);
      transform: translateY(1px);
    }
    .chip.ok{ color:var(--ok-fg); background:var(--ok-bg); border-color:var(--ok-bd) }
    .chip.warn{ color:var(--wn-fg); background:var(--wn-bg); border-color:var(--wn-bd) }
    .chip.bad{ color:var(--bd-fg); background:var(--bd-bg); border-color:var(--bd-bd) }
    .meta .chip:nth-child(-n+3)::before{ display:none }

    .actions{display:flex; gap:8px; flex-wrap:wrap}

    .empty, .error{
      padding:18px; border:1px dashed #2b374c; border-radius:14px;
      background:linear-gradient(180deg,#0f1622,#0c111a);
      color:var(--muted-strong);
    }

    .footer{margin:22px 0 10px; color:var(--muted-strong); font-size:13px}
    .footer a{ color: color-mix(in oklab, var(--accent) 80%, var(--text)) }

    code{
      background: #0f1722; padding:2px 6px; border-radius:6px; border:1px solid #263146;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.95em;
    }

    @container (max-width: 360px){
      .actions a, .actions button{ padding:7px 10px; font-size:13px; }
      .host{ font-size:14px; }
    }

    /* =========================
       DIALOG / QR
       ========================= */
    dialog{ border:none; border-radius:16px; padding:0; overflow:hidden; box-shadow:0 12px 60px #0008 }
    dialog::backdrop{ background: rgba(0,0,0,.55); animation: fadeIn .18s ease-out }
    .dlg{ background:var(--card); border:1px solid #213148; transform-origin: 50% 38%; animation: pop .18s ease-out }
    .dlg header{
      position:sticky; top:0; z-index:1;
      background:linear-gradient(180deg,#0f1622,#0d131d);
      padding:10px 12px; border-bottom:1px solid #213148;
      display:flex; align-items:center; gap:8px; justify-content:space-between;
    }
    .dlg .content{ padding:16px }
    .qr{ display:grid; place-items:center; padding:12px; background:#0f1622; border-radius:12px; border:1px solid #213148 }

    @keyframes pop{ from{ opacity:0; transform: scale(.98) translateY(6px) } to{ opacity:1; transform: scale(1) translateY(0) } }
    @keyframes fadeIn{ from{ opacity:0 } to{ opacity:1 } }

    /* =========================
       POLISH & ACCESSIBILITY
       ========================= */
    *{ scrollbar-width:thin; scrollbar-color:#3a4b66 transparent }
    *::-webkit-scrollbar{ height:10px; width:10px }
    *::-webkit-scrollbar-thumb{ background:#3a4b66; border-radius:8px; border:2px solid transparent; background-clip:padding-box }
    *::-webkit-scrollbar-track{ background:transparent }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important }
    }
    @media (forced-colors: active){
      .tab, button, select, input[type="text"], .actions a { border-color: CanvasText }
      .tab[aria-selected="true"]{ outline: 2px solid Highlight }
      .card{ border-color: CanvasText }
    }

    /* inline help */
    details.help{
      margin:10px 0 14px;
      background:var(--chip);
      border:1px solid var(--chip-border);
      border-radius:12px;
      padding:8px 12px;
      color:var(--muted-strong);
    }
    details.help summary{
      cursor:pointer; user-select:none; font-weight:700; color:var(--text);
      list-style:none;
    }
    details.help[open]{ box-shadow: 0 6px 22px rgba(0,0,0,.25) }
    details.help p, details.help ul{ margin:8px 0 0; font-size:13px; line-height:1.55 }

    /* Contrast boost for filter labels and toolbar counters */
    .filters label,
    .metrics{
      color: color-mix(in oklab, var(--text) 92%, var(--muted) 8%) !important;
      font-weight: 600;
      letter-spacing: .1px;
    }

    /* Full host:port line under the title (high-contrast, wraps) */
    .host-id{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      font-weight: 700;
      line-height: 1.25;
      color: color-mix(in oklab, var(--text) 88%, var(--muted) 12%);
      background: color-mix(in oklab, var(--chip) 70%, white 6%);
      border: 1px dashed var(--chip-border);
      border-radius: 8px;
      padding: 3px 6px;
      margin-top: 2px;
      white-space: normal;
      word-break: break-word;   /* readable wrap */
      overflow-wrap: anywhere;
    }
  </style>
</head>
<body>
  <header>
    <h1>Telegram Proxy Explorer</h1>
    <div class="sub">Public MTProto & SOCKS5 proxies from <code>mtpro.xyz</code>.</div>
    <div class="tabs" role="tablist">
      <button id="tab-mt" class="tab" role="tab" aria-controls="panel-mt" aria-selected="true">MTProto</button>
      <button id="tab-sk" class="tab" role="tab" aria-controls="panel-sk" aria-selected="false">SOCKS5</button>
    </div>
  </header>

  <main>
    <div class="toolbar">
      <label>Sort:
        <select id="sort">
          <option value="ping">Lowest ping</option>
          <option value="uptime">Highest uptime</option>
          <option value="added">Recently added</option>
        </select>
      </label>
      <button id="refresh" title="Refresh list">Refresh</button>
      <span id="count" class="sub metrics" aria-live="polite"></span>
      <span id="updated" class="sub metrics" aria-live="polite"></span>
    </div>

    <!-- Filters -->
    <div class="filters" aria-label="Filters">
      <label>Country
        <select id="filter-country" title="Filter by country">
          <option value="">All</option>
        </select>
      </label>
      <label>Provider
        <input id="filter-provider" type="text" placeholder="e.g., Hetzner" title="Type part of provider/ISP name" />
      </label>
      <div class="seg" role="group" aria-label="Copy format">
        <input type="radio" name="copyfmt" id="fmt-tme" value="tme" checked>
        <label for="fmt-tme">Copy t.me</label>
        <input type="radio" name="copyfmt" id="fmt-tg" value="tg">
        <label for="fmt-tg">Copy tg://</label>
      </div>
      <button id="clearFilters" class="ghost" title="Reset filters and copy mode">Clear</button>
    </div>

    <!-- Help -->
    <details class="help" dir="auto">
      <summary>Quick guide</summary>
      <ul>
        <li><strong>MTProto / SOCKS5</strong>: pick proxy type from tabs.</li>
        <li><strong>Sort</strong>: by ping, uptime, or recently added.</li>
        <li><strong>Country</strong>: filter by country; <em>All</em> disables filter.</li>
        <li><strong>Provider</strong>: type part of DC/ISP name (e.g., Hetzner).</li>
        <li><strong>Copy t.me / tg://</strong>: format used by “Copy link” and QR.</li>
        <li><strong>Refresh</strong>: fetch from API (with mirror fallback).</li>
        <li><strong>Clear</strong>: reset filters and copy mode to <code>t.me</code>.</li>
        <li>Each card has: “Open in Telegram”, “Open on t.me”, “QR Code”, “Copy link”.</li>
      </ul>
    </details>

    <section id="panel-mt" role="tabpanel" aria-labelledby="tab-mt">
      <div id="mt-grid" class="grid" aria-live="polite"></div>
      <div id="mt-empty" class="empty" hidden>Loading…</div>
      <div id="mt-error" class="error" hidden></div>
    </section>

    <section id="panel-sk" role="tabpanel" aria-labelledby="tab-sk" hidden>
      <div id="sk-grid" class="grid" aria-live="polite"></div>
      <div id="sk-empty" class="empty" hidden></div>
      <div id="sk-error" class="error" hidden></div>
    </section>

    <div class="footer">
      Source API: <a href="https://mtpro.xyz/api-overview" target="_blank" rel="noopener">mtpro.xyz / API Overview</a>
      • Mirror JSON: <a href="https://raw.githubusercontent.com/hookzof/socks5_list/master/tg/mtproto.json" target="_blank" rel="noopener">hookzof/mtproto.json</a>
      • <a href="https://raw.githubusercontent.com/hookzof/socks5_list/master/tg/socks.json" target="_blank" rel="noopener">hookzof/socks.json</a>
      <div class="sub" style="margin-top:6px">Security note: These are public proxies. Use only sources you trust. Links use official Telegram deep-link formats (<code>tg://</code> and <code>t.me</code>).</div>
    </div>
  </main>

  <dialog id="qrDialog" class="dlg">
    <header class="row">
      <strong>QR Code</strong>
      <div class="row" style="gap:6px">
        <button id="qrCopy">Copy link</button>
        <button id="qrClose">Close</button>
      </div>
    </header>
    <div class="content">
      <div id="qrBox" class="qr"></div>
      <p id="qrLink" class="sub" style="word-break:break-all"></p>
    </div>
  </dialog>

  <!-- Lightweight QR generator (client-side only) -->
  <!-- SRI حذف شد تا بلاک نشود -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- فالبک: اگر CDN بالا لود نشد، از jsDelivr تلاش کن -->
  <script>
    (function ensureQRCodeLoadedOnce(){
      function present(){ return !!(window.QRCode && window.QRCode.CorrectLevel); }
      if (present()) return;
      var s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js';
      s.async = true;
      s.setAttribute('data-qr-fallback','1');
      s.onload = function(){ console.log('QRCode fallback loaded'); };
      s.onerror = function(){ console.error('QR fallback load failed'); };
      document.head.appendChild(s);
    })();
  </script>

  <script>
  (function(){
    // ---- DOM handles
    const API_MT = 'https://mtpro.xyz/api/?type=mtproto';
    const API_SK = 'https://mtpro.xyz/api/?type=socks';
    const MIR_MT = 'https://raw.githubusercontent.com/hookzof/socks5_list/master/tg/mtproto.json';
    const MIR_SK = 'https://raw.githubusercontent.com/hookzof/socks5_list/master/tg/socks.json';

    const tabMt = document.getElementById('tab-mt');
    const tabSk = document.getElementById('tab-sk');
    const panelMt = document.getElementById('panel-mt');
    const panelSk = document.getElementById('panel-sk');
    const sortSel = document.getElementById('sort');
    const refreshBtn = document.getElementById('refresh');
    const countEl = document.getElementById('count');
    const updatedEl = document.getElementById('updated');

    const mtGrid = document.getElementById('mt-grid');
    const mtEmpty = document.getElementById('mt-empty');
    const mtErr = document.getElementById('mt-error');
    const skGrid = document.getElementById('sk-grid');
    const skEmpty = document.getElementById('sk-empty');
    const skErr = document.getElementById('sk-error');

    const qrDlg = document.getElementById('qrDialog');
    const qrClose = document.getElementById('qrClose');
    const qrCopy = document.getElementById('qrCopy');
    const qrBox = document.getElementById('qrBox');
    const qrLinkP = document.getElementById('qrLink');

    const countrySel = document.getElementById('filter-country');
    const providerInput = document.getElementById('filter-provider');
    const fmtTme = document.getElementById('fmt-tme');
    const fmtTg = document.getElementById('fmt-tg');
    const clearFiltersBtn = document.getElementById('clearFilters');

    // ---- State (aligned with UI defaults)
    let state = {
      mt: [], sk: [],
      tab:'mt', sort:'ping',
      copyFormat:'tme',                  // 'tme' | 'tg'
      filters:{ country:'', provider:'' },
      lastUpdated:null
    };

    // ---- Format helpers
    const fmt = {
      relTime(ts){
        if(!ts) return '';
        const d = new Date(ts*1000);
        const diff = Date.now()-d.getTime();
        const mins = Math.round(diff/60000);
        if(mins<60) return `${mins}m ago`;
        const hours = Math.round(mins/60);
        if(hours<48) return `${hours}h ago`;
        const days = Math.round(hours/24);
        return `${days}d ago`;
      },
      pct(v){return (v==null?'-':`${v}%`)},
      ping(v){
        if(v==null) return ['–','chip'];
        const cls = v<80?'chip ok':(v<200?'chip warn':'chip bad');
        return [`${v} ms`, cls];
      }
    };

    // ---- Link builders
    function tgLinksMT({host, port, secret}){
      const p = new URLSearchParams({server:host, port:String(port), secret:secret});
      return { tg:`tg://proxy?${p}`, tme:`https://t.me/proxy?${p}` };
    }
    function tgLinksSK({ip, port, user, pass}){
      const p = new URLSearchParams({server:ip, port:String(port)});
      if(user) p.set('user', user);
      if(pass) p.set('pass', pass);
      return { tg:`tg://socks?${p}`, tme:`https://t.me/socks?${p}` };
    }

    // ---- Network (with mirror fallback)
    async function getJSON(url){
      const r = await fetch(url, {cache:'no-store'});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }
    async function loadList(primary, mirror){
      try{ return await getJSON(primary); }
      catch(e){ console.warn('Primary failed:', e); return await getJSON(mirror); }
    }

    // ---- Sorting
    function sorters(){
      return {
        ping:(a,b)=> (a.ping??1e9) - (b.ping??1e9),
        uptime:(a,b)=> (b.uptime??-1) - (a.uptime??-1),
        added:(a,b)=> (b.addTime??0) - (a.addTime??0)
      };
    }

    // ---- Text truncation helper (still used in some labels if needed)
    function truncateMiddle(str, max = 40){
      if (!str) return '';
      if (str.length <= max) return str;
      const keep = Math.floor((max - 1) / 2);
      return str.slice(0, keep) + '…' + str.slice(-keep);
    }

    function activeData(){ return state.tab==='mt' ? state.mt : state.sk; }

    // ---- Filters
    function applyFilters(list){
      const {country, provider} = state.filters;
      const p = provider.trim().toLowerCase();
      return list.filter(x=>{
        const okCountry = !country || (x.country||'')===country;
        const okProvider = !p || ((x.provider||'')+'').toLowerCase().includes(p);
        return okCountry && okProvider;
      });
    }

    function updateCountryOptions(){
      const src = activeData();
      const set = new Set();
      src.forEach(x=>{ if(x.country) set.add(x.country); });
      const prev = countrySel.value;
      countrySel.innerHTML = '<option value="">All</option>' + Array.from(set).sort().map(c=>`<option value="${c}">${c}</option>`).join('');
      if (prev && set.has(prev)) countrySel.value = prev;
      else countrySel.value = '';
      state.filters.country = countrySel.value;
    }

    // ---- Render
    function render(){
      const {tab, sort} = state;
      const dataRaw = activeData().slice();
      const grid = tab==='mt' ? mtGrid : skGrid;
      const empty = tab==='mt' ? mtEmpty : skEmpty;
      const err = tab==='mt' ? mtErr : skErr;

      dataRaw.sort(sorters()[sort]);
      const data = applyFilters(dataRaw);

      grid.innerHTML='';
      err.hidden = true;
      empty.hidden = data.length>0;
      if(!empty.hidden) empty.textContent = 'No proxies match your filters.';
      countEl.textContent = `${data.length} proxies`;
      updatedEl.textContent = state.lastUpdated ? ` • Updated ${fmt.relTime(Math.floor(state.lastUpdated/1000))}` : '';

      const frag = document.createDocumentFragment();
      data.forEach(item=>{
        const card = document.createElement('div');
        card.className='card';

        const top = document.createElement('div');
        top.className='top';

        const host = document.createElement('div');
        host.className='host';

        const fullHost = (item.host||item.ip)+":"+item.port;
        host.title = fullHost;
        // Title shows type only (not the IP)
        host.textContent = (item.type === 'mt') ? 'MTProto' : 'SOCKS5';

        // Full, labeled ID line
        const hostId = document.createElement('div');
        hostId.className = 'host-id';
        const fmtIP = v => (v && v.includes(':') ? `[${v}]` : v);
        let idText;
        if (item.type === 'mt') {
          idText = `ip=${fmtIP(item.host || item.ip)} • port=${item.port}` +
                   (item.secret ? ` • secret=${item.secret}` : '');
        } else {
          idText = `ip=${fmtIP(item.ip)} • port=${item.port}` +
                   (item.user ? ` • user=${item.user}` : '') +
                   (item.pass ? ` • pass=${item.pass}` : '');
        }
        hostId.textContent = idText;

        const meta = document.createElement('div');
        meta.className='meta';

        const ctry = document.createElement('span'); ctry.className='chip'; ctry.textContent=item.country||'--'; ctry.title=ctry.textContent;
        const prov = document.createElement('span'); prov.className='chip'; prov.textContent=item.provider||'—'; prov.title=prov.textContent;
        const up = document.createElement('span'); up.className='chip'; up.textContent = 'uptime' in item ? fmt.pct(item.uptime) : '—'; up.title='Uptime';
        const [pingTxt,pingCls] = fmt.ping(item.ping);
        const png = document.createElement('span'); png.className=pingCls; png.textContent=pingTxt; png.title='Ping';

        meta.append(ctry,prov,up,png);
        top.append(host, meta);

        const actions = document.createElement('div');
        actions.className='actions';
        const links = item.type==='mt' ? tgLinksMT(item) : tgLinksSK(item);

        const openBtn = document.createElement('a');
        openBtn.href=links.tg; openBtn.className='primary'; openBtn.textContent='Open in Telegram';

        const webBtn = document.createElement('a');
        webBtn.href=links.tme; webBtn.target='_blank'; webBtn.rel='noopener'; webBtn.textContent='Open on t.me';

        const qrBtn = document.createElement('button');
        qrBtn.textContent='QR Code';
        qrBtn.addEventListener('click',()=>showQR(links[state.copyFormat] || links.tme));

        const copyBtn = document.createElement('button');
        const labelFor = state.copyFormat==='tg' ? 'Copy tg://' : 'Copy t.me';
        copyBtn.textContent=labelFor;
        copyBtn.addEventListener('click',()=>{
          const url = links[state.copyFormat] || links.tme;
          // Clipboard with fallback
          const write = async () => {
            try{
              if(navigator.clipboard && window.isSecureContext){
                await navigator.clipboard.writeText(url);
              }else{
                const ta=document.createElement('textarea');
                ta.value=url; ta.style.position='fixed'; ta.style.opacity='0';
                document.body.appendChild(ta); ta.focus(); ta.select();
                document.execCommand('copy'); document.body.removeChild(ta);
              }
              const old = copyBtn.textContent; copyBtn.textContent='Copied'; setTimeout(()=>copyBtn.textContent=old,1400);
            }catch(e){ alert('Copy failed: '+e.message); }
          };
          write();
        });

        actions.append(openBtn, webBtn, qrBtn, copyBtn);

        const timeRow = document.createElement('div');
        timeRow.className='sub';
        const t1 = item.updateTime||item.addTime; if(t1){ timeRow.textContent = `updated ${fmt.relTime(t1)}`; }

        // order: title/meta -> full ID -> actions -> timestamp
        card.append(top, hostId, actions, timeRow);
        frag.append(card);
      });
      grid.append(frag);
    }

    function setTab(tab){
      state.tab = tab;
      tabMt.setAttribute('aria-selected', tab==='mt'); tabSk.setAttribute('aria-selected', tab==='sk');
      panelMt.hidden = tab!=='mt'; panelSk.hidden = tab!=='sk';
      updateCountryOptions();
      render();
    }

    // ======= QR: نسخهٔ بهبود‌یافته با گارد و فالبک =======
    async function showQR(link){
      qrBox.innerHTML='';
      qrLinkP.textContent='';

      const present = () => !!(window.QRCode && window.QRCode.CorrectLevel);

      // اگر QRCode حاضر نیست، سعی کن منتظر بمانی (فالبک اسکریپت بالایی تزریق دارد)
      if (!present()) {
        // اگر هنوز اسکریپت فالبک تزریق نشده بود، تزریق کن
        if (!document.querySelector('script[data-qr-fallback]')) {
          const s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js';
          s.async = true;
          s.setAttribute('data-qr-fallback','1');
          document.head.appendChild(s);
        }
        // تا 3 ثانیه هر 120ms چک کن
        const ok = await new Promise(resolve=>{
          let waited=0;
          const iv = setInterval(()=>{
            if (present()) { clearInterval(iv); resolve(true); }
            else if ((waited+=120) >= 3000) { clearInterval(iv); resolve(false); }
          },120);
        });
        if (!ok) {
          alert('QR library failed to load (CDN blocked or offline).');
          return;
        }
      }

      try{
        new QRCode(qrBox, {
          text: link,
          width: 220,
          height: 220,
          correctLevel: QRCode.CorrectLevel.M
        });
      }catch(e){
        console.error('QR build error:', e);
        alert('Failed to build QR code. See console for details.');
        return;
      }

      qrLinkP.textContent = link;
      if (qrDlg.showModal) qrDlg.showModal(); else qrDlg.setAttribute('open','');
    }
    // ================================================

    qrClose.addEventListener('click',()=>qrDlg.close());
    qrCopy.addEventListener('click',()=>{const t=qrLinkP.textContent; navigator.clipboard?.writeText(t); qrCopy.textContent='Copied'; setTimeout(()=>qrCopy.textContent='Copy link',1400)});

    // ---- Load & events
    async function loadAll(){
      mtEmpty.hidden=false; skEmpty.hidden=false; countEl.textContent=''; updatedEl.textContent='';
      try{
        const [mt, sk] = await Promise.all([
          loadList(API_MT, MIR_MT),
          loadList(API_SK, MIR_SK)
        ]);
        state.mt = mt.map(x=>({ ...x, type:'mt' }));
        state.sk = sk.map(x=>({ ...x, type:'sk' }));
        state.lastUpdated = Date.now();
        updateCountryOptions();
      }catch(e){
        console.error(e);
        (state.tab==='mt'?mtErr:skErr).hidden=false;
        (state.tab==='mt'?mtErr:skErr).textContent = 'Failed to load lists: '+e.message;
      } finally {
        mtEmpty.hidden=true; skEmpty.hidden=true; render();
      }
    }

    tabMt.addEventListener('click',()=>setTab('mt'));
    tabSk.addEventListener('click',()=>setTab('sk'));
    sortSel.addEventListener('change',()=>{state.sort=sortSel.value; render();});
    refreshBtn.addEventListener('click',()=>loadAll());

    countrySel.addEventListener('change',()=>{state.filters.country = countrySel.value; render();});
    providerInput.addEventListener('input',()=>{state.filters.provider = providerInput.value; render();});

    fmtTme.addEventListener('change',()=>{ if(fmtTme.checked){ state.copyFormat='tme'; render(); } });
    fmtTg.addEventListener('change',()=>{ if(fmtTg.checked){ state.copyFormat='tg'; render(); } });

    clearFiltersBtn.addEventListener('click', ()=>{
      state.filters.country=''; state.filters.provider='';
      countrySel.value=''; providerInput.value='';
      state.copyFormat='tme'; fmtTme.checked = true; fmtTg.checked = false;
      render();
    });

    // keep UI select and state in sync
    sortSel.value = state.sort;

    // Initial fetch
    loadAll();
  })();
  </script>
</body>
</html>
