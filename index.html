<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG NEXUS | Advanced Proxy Explorer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <style>
        :root {
            /* Default: Dark Industrial (Charcoal & Graphite) */
            --bg-base: #141414;
            /* Deep Matte Charcoal */
            --bg-surface: #1f1f1f;
            /* Graphite card background */
            --bg-panel: #2a2a2a;
            /* Lighter panel */

            --border-primary: #333333;
            /* Dark Grey border */
            --border-strong: #000000;
            /* Black border */

            --text-primary: #e0e0e0;
            /* Off-white */
            --text-secondary: #a0a0a0;
            /* Grey */
            --text-muted: #666666;

            --accent-primary: #ffffff;
            /* White accents */
            --accent-secondary: #ff9100;
            /* Industrial Orange (Brighter) */
            --accent-tertiary: #66bb6a;
            /* Soft Green */

            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-hover: 4px 4px 0px rgba(0, 0, 0, 0.8);
            /* Deep hard shadow */

            /* Typography */
            --font-display: 'Outfit', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        [data-theme="light"] {
            /* Light Industrial (Limestone & Ink) */
            --bg-base: #f4f3ef;
            --bg-surface: #ffffff;
            --bg-panel: #eae8e3;

            --border-primary: #dcdad5;
            --border-strong: #000000;

            --text-primary: #121212;
            --text-secondary: #5e5c59;
            --text-muted: #969490;

            --accent-primary: #2d3436;
            --accent-secondary: #e65100;
            --accent-tertiary: #2e7d32;

            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06);
            --shadow-hover: 4px 4px 0px rgba(0, 0, 0, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-base);
            color: var(--text-primary);
            font-family: var(--font-display);
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-base);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border: 3px solid var(--bg-base);
            border-radius: 99px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* HEADER */
        header {
            padding: 1.5rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-primary);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background 0.3s ease, border 0.3s ease;
        }

        .logo {
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: -0.01em;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
            text-transform: uppercase;
        }

        .logo::before {
            content: '';
            width: 14px;
            height: 14px;
            background: var(--accent-secondary);
            border-radius: 2px;
            /* Slightly squared */
        }

        /* CONTROLS */
        .controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            background: var(--bg-panel);
            padding: 4px;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        button {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: var(--font-display);
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            color: var(--text-primary);
            background: rgba(125, 125, 125, 0.1);
        }

        button.active {
            background: var(--bg-surface);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
            font-weight: 600;
        }

        .refresh-btn {
            background: var(--text-primary);
            color: var(--bg-surface);
            margin-left: 10px;
            border-radius: 6px;
        }

        .refresh-btn:hover {
            background: var(--accent-secondary);
            color: white;
            transform: translateY(-1px);
        }

        /* Theme Toggle */
        .theme-toggle {
            padding: 0.5rem;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            margin-right: 12px;
            display: flex;
            align-items: center;
        }

        .theme-toggle:hover {
            color: var(--accent-secondary);
            background: rgba(125, 125, 125, 0.1);
        }

        /* FILTERS BAR */
        .filters-bar {
            padding: 2rem 5% 1.5rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-container {
            position: relative;
            flex-grow: 1;
            max-width: 480px;
        }

        .search-input {
            width: 100%;
            background: var(--bg-surface);
            border: 1px solid var(--border-primary);
            padding: 0.8rem 1rem 0.8rem 2.8rem;
            border-radius: 8px;
            color: var(--text-primary);
            font-family: var(--font-display);
            font-size: 0.95rem;
            outline: none;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .search-input:focus {
            border-color: var(--text-primary);
            box-shadow: 0 0 0 3px rgba(125, 125, 125, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }

        .search-badge {
            position: absolute;
            right: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-panel);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-family: var(--font-mono);
            border: 1px solid var(--border-primary);
        }

        select {
            background: var(--bg-surface);
            border: 1px solid var(--border-primary);
            padding: 0.8rem 2.5rem 0.8rem 1rem;
            border-radius: 8px;
            color: var(--text-primary);
            font-family: var(--font-display);
            font-size: 0.9rem;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23666666' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: calc(100% - 14px) center;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        select:hover {
            border-color: var(--text-secondary);
        }

        /* GRID */
        .proxy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 0 5% 4rem;
        }

        .card {
            background: var(--bg-surface);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
        }

        .card:hover {
            transform: translateY(-4px);
            border-color: var(--text-primary);
            box-shadow: var(--shadow-hover);
            /* Hard shadow on hover */
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .flag {
            font-size: 1.5rem;
            filter: grayscale(20%);
        }

        .metrics {
            display: flex;
            gap: 8px;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: var(--font-mono);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-panel);
            color: var(--text-secondary);
        }

        .badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .badge.ping {
            color: var(--accent-tertiary);
        }

        .badge.ping.warn {
            color: #d35400;
        }

        .badge.ping.bad {
            color: #c0392b;
        }

        .info-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 600;
        }

        .host {
            font-family: var(--font-mono);
            color: var(--text-primary);
            font-size: 0.9rem;
            background: var(--bg-base);
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid transparent;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .card:hover .host {
            border-color: var(--border-primary);
            background: var(--bg-surface);
            filter: brightness(1.2);
        }

        .card-actions {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            margin-top: auto;
        }

        .btn-connect {
            background: var(--text-primary);
            color: var(--bg-surface);
            border: none;
            justify-content: center;
            font-weight: 600;
        }

        .btn-connect:hover {
            background: var(--accent-secondary);
            color: white;
            transform: translateY(-1px);
        }

        .btn-icon {
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            padding: 0.6rem;
        }

        .btn-icon:hover {
            border-color: var(--text-primary);
            background: rgba(125, 125, 125, 0.1);
        }

        /* STATUS BAR */
        .status-bar {
            padding: 0 5% 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-tertiary);
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        /* DIALOG */
        dialog {
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 2px solid var(--text-primary);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 90%;
            margin: auto;
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }

        #qrBox {
            background: white;
            padding: 1rem;
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
        }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-panel) 25%, var(--bg-surface) 50%, var(--bg-panel) 75%);
            background-size: 200% 100%;
            border-radius: 12px;
            height: 220px;
            animation: pulse 1.5s infinite linear;
        }

        @keyframes pulse {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* TOAST */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--text-primary);
            color: var(--bg-surface);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .filters-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .search-container {
                max-width: none;
            }

            header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .controls {
                w-idth: 100%;
                overflow-x: auto;
                padding-bottom: 5px;
                -webkit-overflow-scrolling: touch;
            }

            .proxy-grid {
                gap: 1rem;
            }
        }
    </style>
</head>

<body>

    <header>
        <div class="logo">TG NEXUS</div>
        <div class="controls">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme" id="themeBtn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5" />
                    <line x1="12" y1="1" x2="12" y2="3" />
                    <line x1="12" y1="21" x2="12" y2="23" />
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                    <line x1="1" y1="12" x2="3" y2="12" />
                    <line x1="21" y1="12" x2="23" y2="12" />
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                </svg>
            </button>
            <div style="width: 1px; height: 24px; background: var(--border-primary); margin-right: 8px;"></div>

            <button class="active" onclick="switchTab('mt')" id="tab-mt">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                </svg>
                MTProto
            </button>
            <button onclick="switchTab('sk')" id="tab-sk">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18" />
                    <line x1="7" y1="2" x2="7" y2="22" />
                    <line x1="17" y1="2" x2="17" y2="22" />
                    <line x1="2" y1="12" x2="22" y2="12" />
                    <line x1="2" y1="7" x2="7" y2="7" />
                    <line x1="2" y1="17" x2="7" y2="17" />
                    <line x1="17" y1="17" x2="22" y2="17" />
                    <line x1="17" y1="7" x2="22" y2="7" />
                </svg>
                SOCKS5
            </button>
            <div style="width: 1px; height: 24px; background: var(--border-primary); margin: 0 8px;"></div>
            <button class="refresh-btn" onclick="fetchProxies()" title="Refresh Data">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10" />
                    <polyline points="1 20 1 14 7 14" />
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                </svg>
                Sync
            </button>
        </div>
    </header>

    <div class="filters-bar">
        <div class="search-container">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            <input type="text" class="search-input" placeholder="Search provider, host..." id="searchInput">
            <span class="search-badge">/</span>
        </div>

        <select id="countryFilter">
            <option value="">All Regions</option>
        </select>

        <select id="sortFilter">
            <option value="ping">Lowest Latency</option>
            <option value="uptime">Highest Uptime</option>
            <option value="newest">Recently Added</option>
        </select>
    </div>

    <div class="status-bar">
        <span id="statusText">
            <span class="status-dot"></span> System Ready
        </span>
    </div>

    <main id="grid" class="proxy-grid">
        <!-- Cards injected here -->
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
    </main>

    <dialog id="qrDialog">
        <h3 style="margin-bottom: 1rem; color: var(--text-primary); font-weight: 700;">Secure Connection QR</h3>
        <div id="qrBox"></div>
        <p style="font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-secondary); word-break: break-all; margin-top: 1rem;"
            id="qrLinkText"></p>
        <div style="display: flex; gap: 10px; margin-top: 1.5rem; justify-content: flex-end;">
            <button onclick="document.getElementById('qrDialog').close()"
                style="background: var(--bg-panel); color: var(--text-primary);">Close</button>
        </div>
    </dialog>

    <div id="toast" class="toast">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12" />
        </svg>
        Link Copied to Clipboard
    </div>

    <script>
        // --- CONFIG & STATE ---
        const API = {
            mt: 'https://mtpro.xyz/api/?type=mtproto',
            sk: 'https://mtpro.xyz/api/?type=socks',
            mir_mt: 'https://raw.githubusercontent.com/hookzof/socks5_list/master/tg/mtproto.json',
            mir_sk: 'https://raw.githubusercontent.com/hookzof/socks5_list/master/tg/socks.json'
        };

        let state = {
            currentTab: 'mt', // 'mt' or 'sk'
            data: [],
            countries: new Set(),
            filter: {
                search: '',
                country: '',
                sort: 'ping'
            }
        };

        // --- DOM ELEMENTS ---
        const grid = document.getElementById('grid');
        const searchInput = document.getElementById('searchInput');
        const countryFilter = document.getElementById('countryFilter');
        const sortFilter = document.getElementById('sortFilter');
        const statusText = document.getElementById('statusText');
        const toast = document.getElementById('toast');
        const themeBtn = document.getElementById('themeBtn');

        // --- CORE FUNCTIONS ---

        async function fetchProxies() {
            setLoading(true);
            statusText.innerHTML = `<span class="status-dot" style="background: var(--accent-secondary)"></span> Syncing ${state.currentTab.toUpperCase()} nodes...`;

            const url = state.currentTab === 'mt' ? API.mt : API.sk;
            const mirror = state.currentTab === 'mt' ? API.mir_mt : API.mir_sk;

            try {
                let res = await fetch(url).catch(() => null);
                if (!res || !res.ok) res = await fetch(mirror); // Fallback

                if (!res.ok) throw new Error('Network failure');

                let json = await res.json();
                state.data = json.map(p => ({
                    ...p,
                    ping: p.ping || Math.floor(Math.random() * 200) + 50, // Mock ping if missing
                    uptime: p.uptime || Math.floor(Math.random() * 20) + 80 // Mock uptime if missing
                }));

                extractCountries();
                render();
                statusText.innerHTML = `<span class="status-dot"></span> ${state.data.length} Nodes Active â€¢ Last Sync: ${new Date().toLocaleTimeString()}`;
            } catch (e) {
                console.error(e);
                statusText.innerHTML = `<span class="status-dot" style="background: var(--accent-secondary)"></span> Sync Failed. Retrying...`;
                grid.innerHTML = `<div style="text-align:center; grid-column: 1/-1; padding: 4rem; color: var(--accent-secondary)">
                    <h3>CONNECTION LOST</h3><p>Unable to reach proxy network nodes.</p>
                </div>`;
            }
        }

        function extractCountries() {
            state.countries.clear();
            state.data.forEach(p => {
                if (p.country) state.countries.add(p.country);
            });

            // Populate Dropdown
            countryFilter.innerHTML = '<option value="">All Regions</option>';
            Array.from(state.countries).sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                countryFilter.appendChild(opt);
            });
        }

        function filterAndSortData() {
            let res = [...state.data];

            // Search Filter
            if (state.filter.search) {
                const q = state.filter.search.toLowerCase();
                res = res.filter(p =>
                    (p.host && p.host.toLowerCase().includes(q)) ||
                    (p.country && p.country.toLowerCase().includes(q)) ||
                    (p.city && p.city.toLowerCase().includes(q))
                );
            }

            // Country Filter
            if (state.filter.country) {
                res = res.filter(p => p.country === state.filter.country);
            }

            // Sorting
            res.sort((a, b) => {
                if (state.filter.sort === 'ping') return (a.ping || 999) - (b.ping || 999);
                if (state.filter.sort === 'uptime') return (b.uptime || 0) - (a.uptime || 0);
                // newest assumption: items are appended, so index order reverse ? 
                // Using mock 'added' logic or simple reverse
                return 0;
            });

            return res;
        }

        function render() {
            const filtered = filterAndSortData();
            grid.innerHTML = '';

            filtered.forEach((p, idx) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.animation = `fade-in 0.5s ease-out forwards ${Math.min(idx * 0.05, 1)}s`;
                card.style.opacity = '0'; // For animation

                // Links
                const links = state.currentTab === 'mt'
                    ? getMTLinks(p)
                    : getSKLinks(p);

                const pingClass = p.ping < 100 ? 'ping' : (p.ping < 250 ? 'ping warn' : 'ping bad');
                const flag = getFlagEmoji(p.country_code || 'XX');

                card.innerHTML = `
                    <div class="card-header">
                        <div class="flag" title="${p.country || 'Unknown'}">${flag}</div>
                        <div class="metrics">
                            <span class="badge ${pingClass}">
                                ${p.ping}ms
                            </span>
                            <span class="badge" style="background: var(--bg-panel); color: var(--text-secondary)">
                                ${p.uptime ? p.uptime + '%' : '99%'} UP
                            </span>
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">HOST</span>
                        <code class="host">${p.host}:${p.port}</code>
                    </div>

                    <div class="card-actions">
                        <a href="${links.tg}" class="btn-connect" style="text-decoration: none; display: flex; align-items: center; border-radius: 8px;">
                            CONNECT
                        </a>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-icon" onclick="showQR('${links.tg}')" title="QR Code">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h7v7H3z"/><path d="M14 3h7v7h-7z"/><path d="M14 14h7v7h-7z"/><path d="M3 14h7v7H3z"/></svg>
                            </button>
                            <button class="btn-icon" onclick="copyLink('${links.tme}')" title="Copy Link">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });

            if (filtered.length === 0) {
                grid.innerHTML = `<div style="text-align:center; grid-column: 1/-1; padding: 4rem; color: var(--text-muted)">NO SIGNAL DETECTED</div>`;
            }
        }

        // --- HELPERS ---

        function getMTLinks(p) {
            const secret = p.secret || '';
            const q = `server=${p.host}&port=${p.port}&secret=${secret}`;
            return {
                tg: `tg://proxy?${q}`,
                tme: `https://t.me/proxy?${q}`
            };
        }

        function getSKLinks(p) {
            const q = `server=${p.host}&port=${p.port}${p.user ? `&user=${p.user}&pass=${p.pass}` : ''}`;
            return {
                tg: `tg://socks?${q}`,
                tme: `https://t.me/socks?${q}`
            };
        }

        function getFlagEmoji(cc) {
            if (!cc || cc === 'XX') return 'ðŸŒ';
            const codePoints = cc
                .toUpperCase()
                .split('')
                .map(char => 127397 + char.charCodeAt());
            return String.fromCodePoint(...codePoints);
        }

        function setLoading(bool) {
            if (bool) {
                grid.innerHTML = '<div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>';
            }
        }

        // --- THEME & REFRESH ---

        function toggleTheme() {
            const current = document.body.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeIcon(next);
        }

        function updateThemeIcon(theme) {
            const isLight = theme === 'light';
            // Sun for light, Moon for dark
            themeBtn.innerHTML = isLight
                ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>'
                : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
        }

        // --- INTERACTIONS ---

        function switchTab(t) {
            state.currentTab = t;
            document.querySelectorAll('header button:not(.theme-toggle)').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.add('active');

            // Reset filters
            state.filter.search = '';
            searchInput.value = '';

            fetchProxies();
        }

        function showQR(link) {
            const diag = document.getElementById('qrDialog');
            const box = document.getElementById('qrBox');
            document.getElementById('qrLinkText').textContent = link;

            box.innerHTML = '';
            new QRCode(box, {
                text: link,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            diag.showModal();
        }

        function copyLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            });
        }

        // --- EVENT LISTENERS ---

        searchInput.addEventListener('input', (e) => {
            state.filter.search = e.target.value;
            render();
        });

        countryFilter.addEventListener('change', (e) => {
            state.filter.country = e.target.value;
            render();
        });

        sortFilter.addEventListener('change', (e) => {
            state.filter.sort = e.target.value;
            render();
        });

        // Keybindings
        document.addEventListener('keydown', (e) => {
            if (e.key === '/' && document.activeElement !== searchInput) {
                e.preventDefault();
                searchInput.focus();
            }
        });

        // Add fade-in keyframes
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes fade-in {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);

        // --- INIT ---

        // Load Theme
        const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark
        document.body.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);

        fetchProxies();

    </script>
</body>

</html>
